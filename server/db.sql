-- 1. Tạo bảng NGUOI_DUNG
CREATE TABLE public."NGUOI_DUNG" (
    "MaND" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "MaID" INT UNIQUE,
    "HoND" VARCHAR(100),
    "TenND" VARCHAR(100),
    "Username" VARCHAR(100) UNIQUE NOT NULL,
    "Email" VARCHAR(255) UNIQUE NOT NULL,
    "MatKhau" TEXT NOT NULL,
    "QuyenHan" VARCHAR(20) CHECK ("QuyenHan" IN ('admin', 'member')) DEFAULT 'member',
    "Created_At" TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. Tạo bảng THONG_BAO
CREATE TABLE public."THONG_BAO" (
    "MaTB" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "MaND" INT NOT NULL,
    "TieuDe" VARCHAR(255),
    "NoiDung" TEXT,
    "ThoiGian" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "TrangThai" BOOLEAN DEFAULT FALSE,
    CONSTRAINT fk_nguoidung_thongbao FOREIGN KEY ("MaND") REFERENCES public."NGUOI_DUNG" ("MaND") ON DELETE CASCADE
);

-- 3. Tạo bảng TRANG_THAI_NHA_KINH
CREATE TABLE public."TRANG_THAI_NHA_KINH" (
    "MaTT" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "NhietDo" INT,
    "DoAm" INT,
    "ThoiGian" TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Tạo bảng THANH_VIEN_NHA_KINH
CREATE TABLE public."THANH_VIEN_NHA_KINH" (
    "MaTV" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "MaND" INT NOT NULL,
    "ThoiDiemVao" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "TrangThai" BOOLEAN DEFAULT FALSE,
    CONSTRAINT fk_nguoidung_thanhvien FOREIGN KEY ("MaND") REFERENCES public."NGUOI_DUNG" ("MaND") ON DELETE CASCADE
);

-- 5. Tạo bảng LICH_SU_NHA_KINH
CREATE TABLE public."LICH_SU_NHA_KINH" (
    "MaLS" INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "MaID" INT NOT NULL,
    "ThoiDiemVao" TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    "AnhXacMinh" TEXT,
    "TrangThaiAnh" BOOLEAN DEFAULT TRUE,
    "TrangThai" BOOLEAN DEFAULT FALSE
);

-- 6. Tạo bảng CHI_TIET_LICH_SU
CREATE TABLE public."CHI_TIET_LICH_SU" (
    "MaND" INT,
    "MaLS" INT NOT NULL,
    PRIMARY KEY ("MaND", "MaLS"),
    CONSTRAINT fk_nguoidung_chitiet FOREIGN KEY ("MaND") REFERENCES public."NGUOI_DUNG" ("MaND") ON DELETE CASCADE,
    CONSTRAINT fk_lichsu_chitiet FOREIGN KEY ("MaLS") REFERENCES public."LICH_SU_NHA_KINH" ("MaLS") ON DELETE CASCADE
);

ALTER TABLE public."NGUOI_DUNG" ENABLE ROW LEVEL SECURITY;
ALTER TABLE public."THONG_BAO" ENABLE ROW LEVEL SECURITY;
ALTER TABLE public."TRANG_THAI_NHA_KINH" ENABLE ROW LEVEL SECURITY;
ALTER TABLE public."THANH_VIEN_NHA_KINH" ENABLE ROW LEVEL SECURITY;
ALTER TABLE public."LICH_SU_NHA_KINH" ENABLE ROW LEVEL SECURITY;
ALTER TABLE public."CHI_TIET_LICH_SU" ENABLE ROW LEVEL SECURITY;