# Authentication System Documentation

This document describes the end-to-end authentication flow, from client-side actions to server-side validation.

## Overview
The system uses **JWT (JSON Web Tokens)** for stateless authentication.
- **Access Token**: Short-lived (60 mins), used to authorize API requests.
- **Refresh Token**: Long-lived (1 day), used to obtain new access tokens.

User data is stored in **Supabase**, but the authentication process is managed by **Django** to bridge the gap between custom logic and the database.

## 1. Registration Flow (`/api/auth/register/`)
1.  **Client**: User submits form (First Name, Last Name, Username, Email, Password).
2.  **Server**:
    - Validates no existing user has the same Username or Email.
    - Hashes the password using Django's `make_password`.
    - Inserts a new record into `NGUOI_DUNG` table in Supabase. **Note**: `MaND` (User ID) is auto-generated by the database.
    - Creates a corresponding Django `User` object (for JWT compatibility).
    - Sends a Welcome Email via SMTP.
    - Generates Access/Refresh tokens.
3.  **Client**: Receives tokens and User object, stores tokens in `localStorage`, and updates `AuthContext`.

## 2. Login Flow (`/api/auth/login/`)
1.  **Client**: User submits credentials.
2.  **Server**:
    - Queries Supabase for the user by Username or Email.
    - Verifies the password using `check_password`.
    - Syncs the Django `User` object if needed.
    - Returns Access/Refresh tokens.
3.  **Client**: Stores tokens and redirects to the dashboard.

## 3. Google OAuth Flow (`/api/auth/google/`)
1.  **Client**: Uses `@react-oauth/google` to get an ID Token from Google.
2.  **Client**: Sends this token to server endpoint.
3.  **Server**:
    - Verifies the token with Google (`https://oauth2.googleapis.com/tokeninfo`).
    - Checks if email exists in Supabase.
    - **If Exists**: Logs the user in.
    - **If New**: Creates a new user record with a random password and verified email.
    - Returns Access/Refresh tokens.

## 4. Protected Routes (Client-Side)
The `ProtectedRoute` component (`client/src/components/Auth/ProtectedRoute.jsx`) wraps private routes.
- **Check**: It checks `AuthContext` for a logged-in user.
- **Action**: If no user is found, it automatically redirects to `/login` (or shows the default unauthenticated view).
- **Interceptor**: The Axios interceptor (`client/src/services/api.js`) automatically attaches the `Authorization: Bearer <token>` header to outgoing requests.
- **Refresh**: If an API call fails with 401, the interceptor attempts to use the `refresh_token` to get a new `access_token` seamlessly.

## 5. Password Reset
- **Forgot Password**: Sends an email with a link containing a signed token.
- **Reset Password**: Verifies the signed token and updates the password in Supabase.
